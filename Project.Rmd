---
title: "Testing Data"
output: html_document
date: "2023-11-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(lubridate) #for time calculations.
library(sf)
library(sp)


data_movements = read.csv("movements.csv")
data_restaurant = read.csv("restaurants.csv")

colnames(data_movements)
colnames(data_restaurant)
```

```{r}
sf_movements00 <- data_movements %>%
  filter(id == "I000") %>%
  head(40000)

sf_movements01 <- data_movements %>%
  filter(id == "I001") %>%
  head(40000)

sf_movements02 <- data_movements %>%
  filter(id == "I002") %>%
  head(40000)

sf_movements03 <- data_movements %>%
  filter(id == "I003") %>%
  head(40000)

sf_movements04 <- data_movements %>%
  filter(id == "I004") %>%
  head(40000)

sf_movements05 <- data_movements %>%
  filter(id == "I005") %>%
  head(40000)

sf_movements06 <- data_movements %>%
  filter(id == "I006") %>%
  head(40000)

sf_movements07 <- data_movements %>%
  filter(id == "I007") %>%
  head(40000)

sf_movements08 <- data_movements %>%
  filter(id == "I008") %>%
  head(40000)

sf_movements09 <- data_movements %>%
  filter(id == "I009") %>%
  head(40000)


sf_movement <- rbind(sf_movements00, sf_movements01, sf_movements02, sf_movements03, sf_movements04, sf_movements05, sf_movements06, sf_movements07, 
                      sf_movements08, sf_movements09)

View(sf_movement)
```

```{r}
# Create an sf data frame with movements coordinates
sf_movements <- st_as_sf(sf_movement, coords = c("longitude", "latitude"), crs = 4326)

# Transform movements coordinates to UTM (assuming the same zone as restaurants)
sf_movements_utm = st_transform(sf_movements, crs = 26911)

sf_movements_utm2 <- sf_movements_utm %>%
  mutate(utm = st_coordinates(sf_movements_utm))


View(sf_movements_utm2)
```

```{r}
 #update nov26

# Create an sf data frame with restaurant coordinates
sf_restaurants <- st_as_sf(data_restaurant, coords = c("longitude", "latitude"), crs = 4326)

# Transform movements coordinates to UTM (assuming the same zone as restaurants)
sf_restaurants_utm = st_transform(sf_restaurants, crs = 26911)

sf_restaurants_utm2 <- sf_restaurants_utm %>%
  mutate(utm = st_coordinates(sf_restaurants_utm))

head(sf_restaurants_utm2)
View(sf_restaurants_utm2)
```

```{r}
library(ggplot2)
# Function to create a buffer (radius) around a point in UTM units
create_buffer <- function(restaurant_id, res_name, lon, lat, radius_meters) {
  # Create a data frame with the restaurant coordinates
  restaurant <- data.frame(lon = lon, lat = lat)
  
  # Create an sf (Simple Features) point object
  restaurant_sf <- st_as_sf(restaurant, coords = c("lon", "lat"), crs = 4326)
  
  # Project the point to UTM (change the UTM zone accordingly)
  restaurant_sf_utm <- st_transform(restaurant_sf, crs = 26911)  # UTM zone 33N
  # Create a buffer around the point in UTM units
  buffer <- st_buffer(restaurant_sf_utm, dist = radius_meters)
  
  # Extracting centroid coordinates (utm.X and utm.Y) for each polygon in buffer
  buffer$resID <- restaurant_id
  buffer$res_name <- res_name
  buffer$utm <- st_centroid(buffer)  # Compute centroid
  buffer$utm.X <- st_coordinates(buffer$utm)[, "X"]  # Extract UTM X coordinate
  buffer$utm.Y <- st_coordinates(buffer$utm)[, "Y"]  # Extract UTM Y coordinate
  
  return(buffer)
}

# Restaurant coordinates (longitude and latitude)
restaurant_lon <- data_restaurant$longitude  # Replace with the actual longitude of the restaurant
restaurant_lat <- data_restaurant$latitude  # Replace with the actual latitude of the restaurant

# Radius in meters
radius_meters <- 50 # Replace with the desired radius in meters

# Create a buffer around the restaurant location
buffer_utm <- create_buffer(sf_restaurants_utm2$Restaurant_ID, sf_restaurants_utm2$Name, restaurant_lon, restaurant_lat, radius_meters)

# Plot the result
plot(st_geometry(buffer_utm), main = "Radius around Restaurant (UTM)", col = "lightblue", lwd = 1)

points(x = restaurant_lon, y = restaurant_lat,col = "coral2" , pch = 16, cex = 2)  # Plot the restaurant location

colnames(buffer_utm)
View(buffer_utm)


```


```{r}
library(htmltools)
library(leaflet)
leaflet()%>%
  addTiles()%>%
  addMarkers(lng = data_restaurant$longitude, lat = data_restaurant$latitude, popup = data_restaurant$Name)

head(sf_restaurants)
```

```{r}
# # Create circles around restaurants
# sf_restaurants_circles <- st_buffer(sf_restaurants_utm2, dist = radius_meters)
# 
# # Function to check if a point is inside any restaurant circle
# is_inside_restaurant_circle <- function(point, circles) {
#   inside <- sapply(seq_along(circles), function(i) {
#     st_contains(circles[i], point)
#   })
#   any(inside)
# }
# 
# View(sf_restaurants_circles)
```

```{r}

library(sf)

# Function to filter movements within restaurant zones
filter_movements_within_restaurant <- function(movements, circles, res_name) {
  
  inside <- st_within(movements, circles)
  movements_inside <- movements[unlist(inside), ]
  return(movements_inside)
}

# Filter movements within restaurant zones
movements_within_restaurant <- filter_movements_within_restaurant(sf_movements_utm2, buffer_utm, buffer_utm$res_name)

colnames(buffer_utm)
head(movements_within_restaurant)
View(movements_within_restaurant)

```

```{r}
# Filter movements based on criteria
filtered_movements <- movements_within_restaurant %>%
  filter(In_Restaurant == TRUE) %>%
  group_by(id, Restaurant_ID) %>%
  mutate(Duration = difftime(lead(datetime), datetime, units = "mins")) %>%
  filter(Duration >= 15 & Duration <= 180) %>%
  ungroup()

# Aggregate data to calculate total time spent by each person at each restaurant
agg_data <- filtered_movements %>%
  group_by(id, Restaurant_ID) %>%
  summarise(Total_Time = sum(Duration, na.rm = TRUE))



# Generate the final report
final_report <- agg_data %>%
  left_join(data_restaurant, by = c("Restaurant_ID" = "Restaurant_ID")) %>%
  mutate(Person_ID = coalesce(`Restaurant_ID`, id)) %>%
  arrange(Person_ID, desc(Total_Time))


# Display the final report
final_report
```


```{r}
# Extract and view the geometry column
geometry_column <- st_geometry(sf_movements_utm2)
print(geometry_column)

colnames(agg_data)
colnames(data_restaurant)

```

```{r}
# Check column names in agg_data and data_restaurant
colnames(agg_data)
colnames(data_restaurant)

# Display a few rows of agg_data
head(agg_data)

# Display a few rows of data_restaurant
head(data_restaurant)

# Check unique values in Restaurant_ID column of agg_data
unique(agg_data$Restaurant_ID)

# Check unique values in Restaurant.ID column of data_restaurant
unique(data_restaurant$Restaurant.ID)



```


---
title: "Testing Data"
output: html_document
date: "2023-11-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(lubridate) #for time calculations.


data_movements = read.csv("movements.csv")
data_restaurant = read.csv("restaurants.csv")
View(data_movements)
View(data_restaurant)


colnames(data_movements)

# Load required packages
library(sf)

# Create an sf data frame with coordinates
sf_coords <- st_as_sf(data_movements, coords = c("longitude", "latitude"), crs = 4326)

# Check the resulting sf object
sf_coords

# Transform coordinates to UTM (Zone 11)
sf_coords_utm <- st_transform(sf_coords, crs = 26911)  # 26910 represents UTM Zone 10

coord <- st_coordinates(sf_coords_utm)

# Display the UTM coordinates
View(coord)


          #update nov26

# Convert 'datetime' column to POSIXct format (date and time)
data_movements$datetime <- as.POSIXct(data_movements$datetime, format = "%Y-%m-%d %H:%M:%S")

# Create an sf data frame with restaurant coordinates
sf_restaurants <- st_as_sf(data_restaurant, coords = c("Longitude", "Latitude"), crs = 4326)

# Define a radius for the restaurant circles (you can adjust this as needed)
radius <- 100 # in meters, adjust according to the scale of your data

# Create circles around restaurants
sf_restaurants_circles <- st_buffer(sf_restaurants, dist = radius)

# Function to check if a point is inside any restaurant circle
is_inside_restaurant_circle <- function(point, circles) {
  inside <- sapply(seq_along(circles), function(i) {
    st_contains(circles[i], point)
  })
  any(inside)
}

# Convert movements data to sf
sf_movements <- st_as_sf(data_movements, coords = c("longitude", "latitude"), crs = 4326)

# Transform movements coordinates to UTM (assuming the same zone as restaurants)
sf_movements_utm <- st_transform(sf_movements, crs = st_crs(sf_restaurants))

# Create an empty data frame to store results
results <- data.frame()

# Loop through movements data to track time spent in restaurants
for (i in 1:nrow(sf_movements_utm)) {
  movement <- sf_movements_utm[i, ]
  if (is_inside_restaurant_circle(movement, sf_restaurants_circles)) {
    # This movement is inside a restaurant circle
    current_datetime <- movement$datetime
    person_id <- data_movements[i, "person_id"]
    # Check the next movement entry within 15 minutes
    next_movements <- sf_movements_utm[(i + 1):nrow(sf_movements_utm), ]
    next_in_restaurant <- next_movements[sapply(next_movements, function(m) {
      difftime(m$datetime, current_datetime, units = "mins") <= 15 &&
      is_inside_restaurant_circle(m, sf_restaurants_circles)
    }), ]
    # If the person stays for longer than 15 minutes and less than 3 hours, record the stay
    if (nrow(next_in_restaurant) > 0) {
      exit_time <- min(next_in_restaurant$datetime)
      stay_duration <- difftime(exit_time, current_datetime, units = "mins")
      if (stay_duration >= 15 && stay_duration <= 180) {
        results <- rbind(results, data.frame(person_id = person_id, enter_time = current_datetime, exit_time = exit_time, stay_duration = stay_duration))
      }
    }
  }
}

# Filter out entries where a person might be an employee (stayed more than 3 hours)
potential_employees <- results %>%
  filter(stay_duration > 180)

# Display the potential employees
print(potential_employees)



```
